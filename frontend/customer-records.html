<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Customer ‚Äî Records</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- html2canvas for PNG export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .truth-table table { width:100%; border-collapse:collapse; }
    .truth-table th, .truth-table td { padding:10px 12px; border:1px solid rgba(255,255,255,0.04); text-align:left; vertical-align:middle; }
    .truth-table th { background:linear-gradient(90deg,#7c4dff,#ff6b6b); color:#fff; font-weight:700; }
    .action-btn { padding:6px 8px; border-radius:8px; border:none; cursor:pointer; }
    .btn-del { background:#ff4b4b; color:#fff; }
    .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
    .search { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:#0b0b0b; color:#fff; }
    .total-row td { background: rgba(255,255,255,0.02); font-weight:700; }
    button { cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <h1 class="app-title">üìë Customer ‚Äî Records</h1>
    </header>

    <div class="stage controls">
      <a class="home-btn" href="customer.html">‚¨ÖÔ∏è Back</a>
      <input id="searchBox" class="search" placeholder="Search..." />
      <button id="exportCsvBtn">üìë CSV</button>
      <button id="exportPngBtn">üñº PNG</button>
    </div>

    <div id="tableWrap" class="truth-table" aria-live="polite"></div>
  </div>

<script>
const DATA_KEY  = "customerRecords";
const $ = id => document.getElementById(id);
const tableWrap = $("tableWrap");
const searchBox = $("searchBox");
const exportCsvBtn = $("exportCsvBtn");
const exportPngBtn = $("exportPngBtn");

function loadRecords(){ try { return JSON.parse(localStorage.getItem(DATA_KEY)) || []; } catch(e){ return []; } }
function saveRecords(data){ localStorage.setItem(DATA_KEY, JSON.stringify(data)); }

let records = loadRecords();
const schema = records.length > 0 ? Object.keys(records[0]).map(k => ({name:k,type:isNaN(records[0][k])?"text":"number"})) : [];

function renderTable(){
  records = loadRecords();
  if(schema.length===0){ tableWrap.innerHTML = `<div>No records available.</div>`; return; }

  let html = `<table><thead><tr><th>#</th>`;
  schema.forEach(col => html += `<th>${col.name}</th>`);
  html += `<th>Action</th></tr></thead><tbody>`;

  records.forEach((row,rIdx)=>{
    html += `<tr data-row="${rIdx}"><td>${rIdx+1}.</td>`;
    schema.forEach(col=>{
      const val = row[col.name]===undefined?"":row[col.name];
      html += `<td contenteditable="true" data-field="${col.name}" data-row="${rIdx}">${val}</td>`;
    });
    html += `<td><button class="action-btn btn-del" onclick="deleteRow(${rIdx})">‚ùå</button></td>`;
    html += `</tr>`;
  });

  // Totals for numeric columns
  const numericSums = {};
  schema.forEach(col=>numericSums[col.name]=0);
  let hasNumeric=false;
  records.forEach(r=>{
    schema.forEach(col=>{
      const v=parseFloat(r[col.name]);
      if(!isNaN(v)){ numericSums[col.name]+=v; hasNumeric=true; }
    });
  });

  if(hasNumeric){
    html += `<tfoot><tr class="total-row"><td><strong>Total</strong></td>`;
    schema.forEach(col=>{
      const sum = numericSums[col.name];
      html += `<td>${(sum!==0?Number(sum.toFixed(2)):"")}</td>`;
    });
    html += `<td></td></tr></tfoot>`;
  }

  html += `</table>`;
  tableWrap.innerHTML = html;

  tableWrap.querySelectorAll("td[contenteditable='true']").forEach((td,i,arr)=>{
    td.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){ e.preventDefault(); const next=arr[i+1]; if(next){ next.focus(); selectCellText(next); } }
    });
    td.addEventListener("blur", onCellBlur);
  });
}

function selectCellText(td){ if(!td) return; const range=document.createRange(); range.selectNodeContents(td); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range); }

function onCellBlur(e){
  const td=e.target;
  const rowIdx=parseInt(td.dataset.row,10);
  const field=td.dataset.field;
  if(isNaN(rowIdx)||!field) return;
  const text=td.innerText;
  const colDef = schema.find(s=>s.name===field);
  if(colDef && colDef.type==="number"){
    const n=parseFloat(text);
    records[rowIdx][field]=isNaN(n)?"":Number(n);
  } else {
    records[rowIdx][field]=text;
  }
  saveRecords(records);
  updateTotalsRow();
}

function updateTotalsRow(){
  const table=tableWrap.querySelector("table");
  if(!table) return;
  const tfoot=table.querySelector("tfoot");
  if(!tfoot) return;
  const numericSums={}; schema.forEach(col=>numericSums[col.name]=0);
  let hasNumeric=false;
  records.forEach(r=>{
    schema.forEach(col=>{
      const v=parseFloat(r[col.name]);
      if(!isNaN(v)){ numericSums[col.name]+=v; hasNumeric=true; }
    });
  });
  const tds=tfoot.querySelectorAll("td");
  for(let i=0;i<schema.length;i++){ tds[i+1].textContent=(numericSums[schema[i].name]!==0?Number(numericSums[schema[i].name].toFixed(2)):""); }
}

function deleteRow(idx){ if(!confirm("Delete this row?")) return; records.splice(idx,1); saveRecords(records); renderTable(); }

searchBox.addEventListener("input",(e)=>{
  const q=String(e.target.value||"").toLowerCase().trim();
  tableWrap.querySelectorAll("tbody tr").forEach(tr=>{ tr.style.display=tr.innerText.toLowerCase().includes(q)?"":"none"; });
});

exportCsvBtn.addEventListener("click",()=>{
  if(!records || records.length===0){ alert("No data to export"); return; }
  const header=["#"].concat(schema.map(s=>s.name)).join(",");
  const rows=records.map((r,i)=>{ const vals=schema.map(s=>{ const v=r[s.name]===undefined?'""':String(r[s.name]).replace(/"/g,'""'); return `"${v}"`; }); return `${i+1},${vals.join(",")}`; }).join("\n");
  const csv=header+"\n"+rows;
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="customers.csv"; a.click();
});

exportPngBtn.addEventListener("click",()=>{
  const el=tableWrap; if(!el){ alert("Nothing to export"); return; }
  html2canvas(el,{scale:2,backgroundColor:null}).then(canvas=>{
    const a=document.createElement("a");
    a.href=canvas.toDataURL("image/png");
    a.download="customers.png";
    a.click();
  }).catch(err=>{ console.error(err); alert("PNG export failed."); });
});

// initial render
renderTable();
</script>
</body>
</html>
