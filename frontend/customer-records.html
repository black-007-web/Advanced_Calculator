<!DOCTYPE html>
<html lang="en">
<head>
  
  <!-- Favicon and Tab Styling -->
  <link rel="icon" href="customer-records.png" type="image/png" />
  <meta name="theme-color" content="#00ffd5" />
  
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customer ‚Äî Records</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  .truth-table table { width:100%; border-collapse:collapse; margin-bottom:20px; }
  .truth-table th, .truth-table td { padding:10px 12px; border:1px solid rgba(255,255,255,0.04); text-align:left; vertical-align:middle; }
  .truth-table th { background:linear-gradient(90deg,#7c4dff,#ff6b6b); color:#fff; font-weight:700; }
  .action-btn { padding:6px 8px; border-radius:8px; border:none; cursor:pointer; }
  .btn-del { background:#ff4b4b; color:#fff; }
  .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap; }
  .search { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:#0b0b0b; color:#fff; }
  .date-group { margin-bottom:30px; }
  .date-group h3 { margin-bottom:8px; color:#fff; font-size:1.05rem; }
  .total-row td { background: rgba(255,255,255,0.02); font-weight:700; }
  .btn { background:linear-gradient(90deg,#7c4dff,#ff6b6b); color:#fff; border:none; padding:8px 14px; border-radius:8px; font-weight:600; cursor:pointer; }
  .btn:hover { opacity:0.95; }
  .tiny { color:#9aa0a6; font-size:.95rem; padding:8px 10px; }
</style>
</head>
<body>
<div class="container">
  <header class="site-header">
    <h1 class="app-title">üìë Customer ‚Äî Records</h1>
  </header>

  <div class="stage controls">
    <a class="home-btn" href="customer.html">‚¨ÖÔ∏è Back</a>
    <input id="searchBox" class="search" placeholder="Search..." />
    <button id="exportCsvBtn" class="btn">üìë CSV</button>
    <button id="exportPngBtn" class="btn">üñº PNG</button>
  </div>

  <div id="tableWrap" class="truth-table" aria-live="polite"></div>
</div>

<script>
const DATA_KEY = "customerRecords";
const $ = id => document.getElementById(id);
const tableWrap = $("tableWrap");
const searchBox = $("searchBox");
const exportCsvBtn = $("exportCsvBtn");
const exportPngBtn = $("exportPngBtn");

function loadRecords(){ try { return JSON.parse(localStorage.getItem(DATA_KEY)) || []; } catch(e){ return []; } }
function saveRecords(data){ localStorage.setItem(DATA_KEY, JSON.stringify(data)); }

let records = loadRecords();

// Detect column type correctly
function buildSchema(){
  const keys = [];
  records.forEach(r => {
    Object.keys(r).forEach(k => { if (!keys.includes(k) && k !== "_recordDate") keys.push(k); });
  });
  if (records.some(r => 'Rate' in r && 'Amount' in r) && !keys.includes('Income')) keys.push('Income');
  if (records.some(r => 'Income' in r && 'Expenses' in r) && !keys.includes('Profit')) keys.push('Profit');

  return keys.map(k => {
    let val;
    for (const r of records) { if (r[k] !== undefined) { val = r[k]; break; } }
    const isNum = typeof val === 'number';
    return { name: k, type: isNum ? 'number' : 'text' };
  });
}

function groupByDate(recs){
  const groups = {};
  recs.forEach(r => { const date = r._recordDate || "No Date"; if(!groups[date]) groups[date]=[]; groups[date].push(r); });
  return groups;
}

function renderTable(){
  records = loadRecords();
  if(!records || records.length===0){ tableWrap.innerHTML="<div class='tiny'>No records available.</div>"; return; }

  records.forEach(r=>{
    if('Rate' in r && 'Amount' in r) r['Income']=(parseFloat(r['Rate'])||0)*(parseFloat(r['Amount'])||0);
    if('Income' in r && 'Expenses' in r) r['Profit']=(parseFloat(r['Income'])||0)-(parseFloat(r['Expenses'])||0);
  });

  const schema = buildSchema();
  const displaySchema = schema.filter(s => s.name.toLowerCase()!=='_recorddate');
  const grouped = groupByDate(records);

  let html = "";
  Object.keys(grouped).sort().forEach(date=>{
    const rows = grouped[date];
    html += `<div class="date-group"><h3>${date}</h3><table><thead><tr>`;
    displaySchema.forEach(col=>html+=`<th>${col.name}</th>`);
    html+=`<th>Action</th></tr></thead><tbody>`;

    rows.forEach((r, idx)=>{
      html+=`<tr data-date="${date}" data-index="${idx}">`;
      displaySchema.forEach(col=>{
        const val = r[col.name] ?? "";
        html+=`<td contenteditable="true" data-field="${col.name}" data-date="${date}" data-index="${idx}">${val}</td>`;
      });
      html+=`<td><button class="action-btn btn-del" onclick="deleteRow('${date}',${idx})">‚ùå</button></td></tr>`;
    });

    // Totals only for numeric fields
    const numericSums = {};
    displaySchema.forEach(c => { if(c.type==='number') numericSums[c.name]=0; });
    rows.forEach(r=>{
      displaySchema.forEach(c=>{
        if(c.type==='number'){
          const n = parseFloat(r[c.name]);
          if(!isNaN(n)) numericSums[c.name]+=n;
        }
      });
    });

    html+=`<tfoot><tr class="total-row"><td><strong>Total</strong></td>`;
    for(let i=1;i<displaySchema.length;i++){
      const c=displaySchema[i];
      html+=`<td>${c.type==='number'?Number(numericSums[c.name].toFixed(2)):""}</td>`;
    }
    html+=`<td></td></tr></tfoot></table></div>`;
  });

  tableWrap.innerHTML = html;

  tableWrap.querySelectorAll("td[contenteditable='true']").forEach(td=>{
    td.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); td.blur(); } });
    td.addEventListener("blur", onCellBlur);
  });
}

function onCellBlur(e){
  records=loadRecords();
  const td=e.target;
  const date=td.dataset.date;
  const idx=parseInt(td.dataset.index,10);
  const field=td.dataset.field;
  if(!date||isNaN(idx)||!field) return;

  const grouped=groupByDate(records);
  const row=grouped[date]?.[idx];
  if(!row) return;

  let val=td.innerText;
  const schema=buildSchema();
  const colDef=schema.find(s=>s.name===field);
  row[field]=(colDef?.type==='number')?(parseFloat(val)||0):val;

  records=Object.values(grouped).flat();
  records.forEach(r=>{
    if('Rate' in r && 'Amount' in r) r['Income']=(parseFloat(r['Rate'])||0)*(parseFloat(r['Amount'])||0);
    if('Income' in r && 'Expenses' in r) r['Profit']=(parseFloat(r['Income'])||0)-(parseFloat(r['Expenses'])||0);
  });
  saveRecords(records);
  renderTable();
}

function deleteRow(date, idx){
  records=loadRecords();
  const grouped=groupByDate(records);
  if(!grouped[date]) return;
  grouped[date].splice(idx,1);
  records=Object.values(grouped).flat();
  saveRecords(records);
  renderTable();
}

searchBox.addEventListener("input", e=>{
  const q=String(e.target.value||"").toLowerCase().trim();
  tableWrap.querySelectorAll("tbody tr").forEach(tr=>{ tr.style.display=tr.innerText.toLowerCase().includes(q)?"":"none"; });
});

exportCsvBtn.addEventListener("click", ()=>{
  records=loadRecords();
  if(!records || records.length===0){ alert("No data to export"); return; }
  const schema=buildSchema();
  const displaySchema=schema.filter(s=>s.name.toLowerCase()!=='_recorddate');
  const grouped=groupByDate(records);
  let csv="";
  Object.keys(grouped).forEach(date=>{
    const rows=grouped[date];
    csv+=`Date: ${date}\n`;
    csv+=displaySchema.map(c=>c.name).join(",")+"\n";
    rows.forEach(r=>{
      const line=displaySchema.map(c=>{
        const v=r[c.name]; return (v===undefined||v===null)?"":String(v).replace(/"/g,'""');
      }).map(v=>`"${v}"`).join(",");
      csv+=line+"\n";
    });
    csv+="\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="customers.csv";
  a.click();
});

exportPngBtn.addEventListener("click", () => {
  const el = tableWrap;
  if (!el) {
    alert("Nothing to export");
    return;
  }

  // Save original styles
  const originalHeight = el.style.maxHeight;
  const originalOverflow = el.style.overflow;

  // Expand container to show all content
  el.style.maxHeight = "none";
  el.style.overflow = "visible";

  html2canvas(el, {
    scale: 2,
    backgroundColor: null,
    useCORS: true
  }).then(canvas => {
    const a = document.createElement("a");
    a.href = canvas.toDataURL("image/png");
    a.download = "customers.png";
    a.click();

    // Restore original styles
    el.style.maxHeight = originalHeight;
    el.style.overflow = originalOverflow;
  }).catch(err => {
    console.error(err);
    alert("PNG export failed.");
  });
});


renderTable();
</script>
</body>
</html>



